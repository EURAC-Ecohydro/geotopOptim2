<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emanuele Cordano">
<meta name="dcterms.date" content="2016-10-10">

<title>GEOtop Calibration through Optimization (geotopOptim2)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="geotopOptim2_document_files/libs/clipboard/clipboard.min.js"></script>
<script src="geotopOptim2_document_files/libs/quarto-html/quarto.js"></script>
<script src="geotopOptim2_document_files/libs/quarto-html/popper.min.js"></script>
<script src="geotopOptim2_document_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="geotopOptim2_document_files/libs/quarto-html/anchor.min.js"></script>
<link href="geotopOptim2_document_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="geotopOptim2_document_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="geotopOptim2_document_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="geotopOptim2_document_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="geotopOptim2_document_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#geotop-hydrological-model" id="toc-geotop-hydrological-model" class="nav-link" data-scroll-target="#geotop-hydrological-model">GEOtop Hydrological Model</a></li>
  <li><a href="#overview-of-the-main-function" id="toc-overview-of-the-main-function" class="nav-link" data-scroll-target="#overview-of-the-main-function">Overview of the main function</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  <li><a href="#examples" id="toc-examples" class="nav-link" data-scroll-target="#examples">Examples</a></li>
  <li><a href="#visulatization-tools" id="toc-visulatization-tools" class="nav-link" data-scroll-target="#visulatization-tools">Visulatization tools</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">GEOtop Calibration through Optimization (geotopOptim2)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emanuele Cordano </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 10, 2016</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">September 13, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you encounter errors while rendering this Quarto document, set <code>eval=FALSE</code> for the code blocks in the document. Otherwise, you will need to manually configure the file paths and other settings.</p>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The <code>geotopOptim2</code> package has been built to perform a PSO Calibration through <a href="https://cran.r-project.org/web/packages/hydroPSO/index.html" target="_blank">hydroPSO</a> package of the the results of the physically-based hydrological model GEOtop. The package makes use of the GEOtop-R plugin <a href="https://cran.r-project.org/package=geotopbricks" target="_blank">geotopbricks</a>, which import/export GEOtop Data into R.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>At the time of modification, the <code>hydroPSO</code> package was archived from CRAN repository since <code>2023-10-16</code> and is no longer available. However, you can still install this package into R from the <a href="https://github.com/hzambran/hydroPSO" target="_blank">github</a> using the following method:</p>
<pre><code>library(devtools)
install_github("hzambran/hydroPSO")</code></pre>
</div>
</div>
<p>Before using the <code>geotopOptim2</code>, You need to have the following software installed:</p>
<ol type="1">
<li><a href="https://www.r-project.org" target="_blank">R</a></li>
<li><a href="https://git-scm.com" target="_blank">Git</a></li>
<li><a href="http://geotopmodel.github.io/geotop/" target="_blank">GEOtop</a></li>
</ol>
</section>
<section id="geotop-hydrological-model" class="level2">
<h2 class="anchored" data-anchor-id="geotop-hydrological-model">GEOtop Hydrological Model</h2>
<p><a href="http://geotopmodel.github.io/geotop/" target="_blank">GEOtop</a> (Endrizzi et al, 2014 and references therein) is a distributed model of the mass and energy balance of the hydrological cycle. GEOtop is applicable to simulations in continuum in small or relatively large mountain catchments. GEOtop deals with the effects of topography on the interaction between energy balance and hydrological cycle (water, glacier and snow) with peculiar solutions. The source code of GEOtop 2.0 with detailed documentation is available for researchers and environmental/software engineers through the following links:</p>
<ul>
<li><a href="https://github.com/geotopmodel/geotop" target="_blank">https://github.com/geotopmodel/geotop</a></li>
<li><a href="https://github.com/se27xx/GEOtop/" target="_blank">https://github.com/se27xx/GEOtop/</a></li>
</ul>
<p>So far, goeotpOpintm2 has been used only with the <a href="https://github.com/se27xx/GEOtop" target="_blank">se27xx</a> version under linux.</p>
<p>For Unix-like OS users, the GEOtop 2.0 version can be rapidly downloaded and compiled with the following instructions (<a href="https://github.com/se27xx/GEOtop/" target="_blank">https://github.com/se27xx/GEOtop/</a>):</p>
<ol type="1">
<li>Open a console/terminal and go to the directory where to clone the GEOtop source code</li>
<li>Clone the source code by typing the following:</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>git clone https:/<span class="at">/github</span>.com<span class="at">/se27xx/GEOtop</span>.git</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="3" type="1">
<li>Enter GEOtop directory by typing the following:</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> geotop<span class="at">-se27xx</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="4" type="1">
<li>Create the sub directory for the executable file</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">mkdir</span> bin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="5" type="1">
<li>Build and create GEOtop executale file:</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode cmd code-with-copy"><code class="sourceCode dosbat"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>make <span class="at">-f</span> geotop.make</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once compilation is finished, the GEOtop executable will be created in the sub directory <code>bin</code>. For compiling other versions of GEOtop, please see the related URLs.</p>
<p>Additionally, If you want to use <a href="https://github.com/geotopmodel/geotop" target="_blank">GEOtop 3.0</a> version supported by a larger community, then please refer to the detailed instructions on <a href="https://github.com/geotopmodel/geotop#compiling" target="_blank">installation</a>.</p>
</section>
<section id="overview-of-the-main-function" class="level2">
<h2 class="anchored" data-anchor-id="overview-of-the-main-function">Overview of the main function</h2>
<p><code>geotopOptim2</code> is a R package which is able to enter a GEOtop simulation folder and calibrate some parameters (set by the user) by optimizing a Goodnes-of-Fit measure between point results and point observations. geotopOptim2 is a set of functions that call dependency functions, and allowing the user to work with all or some of these functions based on his or her preferences. Before entering <code>geotopOptim2</code>, here is a list of the main functions:</p>
<ul>
<li><strong>geotopExec</strong> : This function executes a simulation of GEOtop given a certain set of parameters:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(geotopOptim2)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(geotopExec,<span class="at">help_type=</span><span class="st">"html"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(get.geotop.keyword.inpts.value,<span class="at">help_type =</span> <span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>geotopLookUpTable</strong>: It read the lookup table that can be inserted within a GEOtop point simulation according Read point output from GEOtop for verification of the model results:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(geotopLookUpTable,<span class="at">help_type=</span><span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To use this function, the observation point value must be set in the GEOtop simulation and inserted as additional keywords in the <strong>geotop.inpts</strong> file , see the following file for the package example simulation (look at the final OBSERVATION section):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  wpath_sim <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">'geotopOptim2/inst/geotop-simulation/B2site'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  inpts.file.path <span class="ot">&lt;-</span> <span class="fu">paste</span>(wpath_sim,<span class="st">"geotop.inpts"</span>,<span class="at">sep=</span><span class="st">"/"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  inpts <span class="ot">&lt;-</span> <span class="fu">readLines</span>(inpts.file.path)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>(inpts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>! Input for GEOtop 2.0 Endirzzi version
! Plot simulation  
! Station B2 in Montecini
 
!Simulation B2_BeG_017
! Use exact date format i.e. not 1/4 but 01/04 not 0:00 but 00:00 
! Calculation max time step dt in s 
 
TimeStepEnergyAndWater  =   900
InitDateDDMMYYYYhhmm    =   09/04/2014 18:00  
EndDateDDMMYYYYhhmm =   01/01/2016 00:00

!Simulation settings
RecoverSim  =   0
PointSim    =   1

WaterBalance    =   1
EnergyBalance   =   1

!Dt in hours
DtPlotDischarge =   1
DtPlotBasin =   1
DtPlotPoint =   1
StandardTimeSimulation  =   1

!Catchmentcentroid(for Sun position)
Latitude    =   46.668
Longitude   =   10.579

!Energybudgetsettings
FlagSkyViewFactor   =   1
LWinParameterization    =   4
MoninObukhov    =   2
CanopyStabCorrection    =   1
 
!=======================================
!METEO STATIONS
!=======================================

NumberOfMeteoStations   =   1
MeteoStationCoordinateX=620815.
MeteoStationCoordinateY=    5171506
MeteoStationElevation=  1480
MeteoStationWindVelocitySensorHeight    =   2.5
MeteoStationTemperatureSensorHeight =   2


MeteoStationLatitude=46.55 
MeteoStationLongitude=7.99 



!=======================================
!METEO HAEDERS
!=======================================

HeaderDateDDMMYYYYhhmmMeteo =   "Date"
HeaderJulianDayfrom0Meteo   =   "JDfrom0"
HeaderIPrec                 =   "Iprec"
HeaderWindVelocity          =   "WindSp"
HeaderWindDirection         =   "WindDir"
HeaderWindX                 =   "WindX" 
HeaderWindY                 =   "WindY"
HeaderRH                    =   "RelHum"
HeaderAirTemp               =   "AirT" 
HeaderDewTemp               =   "DewT"
HeaderAirPress              =   "AirP" 
HeaderSWglobal              =   "Swglobal" 
HeaderCloudSWTransmissivity =   "CloudTrans" 
HeaderLWin                  =   "LWin"

!=======================================
!POINT SETTINGS
!=======================================

CoordinatePointX    =   620815
CoordinatePointY    =   5171506
PointElevation      =   1480
PointSlope          =   15
PointAspect         =   225

!======================================= 
! LAND COVER 
!======================================= 
! Meadow

NumLandCoverTypes   =   1 
SoilRoughness       =   100 
ThresSnowSoilRough  =   100 
VegHeight           =   400
ThresSnowVegUp      =   50 
ThresSnowVegDown    =   10 
LSAI                =   4
CanopyFraction      =   1 
DecayCoeffCanopy    =   2.0 
VegSnowBurying      =   1 
RootDepth           =   250 
MinStomatalRes      =   25 
VegReflectVis       =   0.1 
VegReflNIR          =   0.2 
VegTransVis         =   0.07 
VegTransNIR         =   0.25 
LeafAngles          =   0 
CanDensSurface      =   0.5 
SoilAlbVisDry       =   0.15 
SoilAlbNIRDry       =   0.25 
SoilAlbVisWet       =   0.15 
SoilAlbNIRWet       =   0.25 
SoilEmissiv         =   0.96 
SurFlowResLand      =   0.5 
SurFlowResExp       =   0.667 

!======================================= 
!Vegetation
!======================================= 
TimeDependentVegetationParameterFile    =   "vegetation_par"


!======================================= 
!Numerical parameters 
!======================================= 
 RichardTol                     =   1.E-7 
MinLambdaWater                  =   1.E-7 
RichardMaxIter                  =   100 
MaxTimesHalvingTimeStepWater    =   20 
MaxCourantSupFlowLand           =   0.1 
MinSupWaterDepthLand            =   1 
MinTimeStepSupFlow              =   1 
HeatEqTol                       =   1.E-4 
HeatEqMaxIter                   =   200 
MaxTimesHalvingTimeStepEnergy   =   5 
CanopyMaxIter                   =   2
BusingerMaxIter                 =   2 
TsMaxIter                       =   2
LocMaxIter                      =   2

!======================================= 
! SNOW AND GLACIERS 
!======================================= 
NumMaxSnowLayers        =   5 
InfiniteSnowLayer       =   2 
MinLayerThicknessSnow   =   5,120,30,5,5 
MaxLayerThicknessSnow   =   20,1.E10,150,50,10 
 
!======================================= 
! SOIL 
!======================================= 
PointSoilType                       = 1
SoilLayerTypes                      = 1
! [mm]  
InitWaterTableHeightOverTopoSurface =   -2000 
! [C] 
InitSoilTemp                        =   4 
ThermalConductivitySoilSolids       =   1.9
ThermalCapacitySoilSolids           =   2.16E+06
! [mm^-1]  
HeaderSoilDz                    =   "Dz"
HeaderLateralHydrConductivity   =   "Kh"
HeaderNormalHydrConductivity    =   "Kv"
HeaderThetaRes                  =   "vwc_r"
HeaderWiltingPoint              =   "vwc_w"
HeaderFieldCapacity             =   "vwc_fc"
HeaderThetaSat                  =   "vwc_s"
HeaderAlpha                     =   "alpha"
HeaderN                         =   "n"
HeaderSpecificStorativity       =   "stor"
HeaderKthSoilSolids             =   "Kth"
HeaderCthSoilSolids             =   "Cth"
HeaderSoilInitPres = "InitPsi"

FreeDrainageAtBottom    =   1

!======================================= 
! FILE NAMES 
!======================================= 

! Input files 

DemFile                 =   "dem"
MeteoFile="meteoB2_irr_"
LandCoverMapFile        =   "landcover"
SkyViewFactorMapFile    =   "sky"
SlopeMapFile            =   "slope"
AspectMapFile           =   "aspect"
CurvaturesMapFile       =   "curvature" 
HorizonMeteoStationFile =   "horizon" 
RiverNetwork            =   "net60"
SoilMapFile             =   "soiltype"
SoilParFile             =   "soil/soil"


HeaderHorizonAngle          = "AngleFromNorthClockwise" 
HeaderHorizonHeight         = "HorizonHeight" 

 
! Output files 

! Tabs 
DischargeFile                   =   "tabs/discharge"
PointOutputFile                 =   "tabs/point" 
PointAll = 1
!SnowProfileFile                =   "tabs/snow"
SnowDepthLayersFile             =   "tabs/snowDepth"
SnowTempProfileFile             =   "tabs/snowT"
SnowLiqContentProfileFile       =   "tabs/snowLiq"
SnowIceContentProfileFile       =   "tabs/snowIce"
SnowAll = 1
BasinOutputFile                 =   "tabs/basin" 
BasinAll = 1
SoilAveragedTempProfileFile     =   "tabs/soilTz" 
SoilLiqWaterPressProfileFile    =   "tabs/psiz" 
SoilLiqContentProfileFile       =   "tabs/thetaliq" 
SoilIceContentProfileFile       =   "tabs/thetaice" 
SoilAll = 1
! Maps
SoilAveragedTempTensorFile      =   "maps/T"
SoilLiqContentTensorFile        =   "maps/thetaliq"
IceLiqContentTensorFile         =   "maps/thetaice"
SoilLiqWaterPressTensorFile     =   "maps/psiz"

LandSurfaceWaterDepthMapFile    =   "maps/hsup"
WaterTableDepthMapFile          =   "maps/watertable"

SWEMapFile                      =   "maps/SWE"
SnowDepthMapFile                =   "maps/snowdepth"

SurfaceHeatFluxMapFile          =   "maps/EB"
SurfaceSensibleHeatFluxMapFile  =   "maps/H"
SurfaceLatentHeatFluxMapFile    =   "maps/LE"
SurfaceTempMapFile              =   "maps/Ts"


!======================================= 
! OBSERVATION
!=======================================

!&gt;&gt;!ObservationProfileFile = "obs/obs"
!&gt;&gt;!ObservationLookupTblFile = "lookup_tbl_observation"</code></pre>
</div>
</div>
<p>In the observation section, two new keywords are set (the symbols <code>!&gt;&gt;!</code> means that the keyword is not read by GEOtop!): <code>ObservationProfileFile</code>, <code>ObservationLookupTblFile</code>. The first is similar to <code>PointFile</code> or <code>SoilLiqContentProfileFile</code> and refers to a set of csv files containing time series of observed variable values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geotopbricks)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: raster</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: sp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: stringr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: zoo</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'zoo'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    as.Date, as.Date.numeric</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: sf</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.11.0, GDAL 3.5.3, PROJ 9.1.0; sf_use_s2() is TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> <span class="fu">get.geotop.inpts.keyword.value</span>(<span class="st">"ObservationProfileFile"</span>,<span class="at">wpath=</span>wpath_sim,<span class="at">data.frame=</span><span class="cn">TRUE</span>,<span class="at">date_field=</span><span class="st">'Date12.DDMMYYYYhhmm.'</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(obs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'zoo' series from 2009-10-02 to 2016-01-11 07:00:00
  Data: num [1:55016, 1:10] 0 0 0 0 0 0 0 0 0 0 ...
 - attr(*, "dimnames")=List of 2
  ..$ : NULL
  ..$ : chr [1:10] "rainfall_amount" "wind_speed" "wind_from_direction" "relative_humidity" ...
  Index:  POSIXlt[1:55016], format: "2009-10-02 00:00:00" "2009-10-02 01:00:00" "2009-10-02 02:00:00" ...</code></pre>
</div>
</div>
<p>The second one refers to a txt file containing a table with the correspondance between the observation variables and the variables simulated by GEOtop:</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>there is no formatter in the file name and the separator is <code>;</code> , so please set <code>formatter="", col_sep=";"</code> instead of default values):</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ltk <span class="ot">&lt;-</span> <span class="fu">get.geotop.inpts.keyword.value</span>(<span class="st">"ObservationLookupTblFile"</span>,<span class="at">wpath=</span>wpath_sim,<span class="at">data.frame=</span><span class="cn">TRUE</span>,<span class="at">formatter=</span><span class="st">""</span>,<span class="at">col_sep=</span><span class="st">";"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in sprintf(formatter[i], level[i]): one argument not used by format ''</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ltk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              obs_var    geotop_where
1     air_temperature PointOutputFile
2     rainfall_amount PointOutputFile
3   relative_humidity PointOutputFile
4          wind_speed PointOutputFile
5 wind_from_direction PointOutputFile
6        air_pressure PointOutputFile
                                  geotop_what   unit
1                                     Tair.C.   degC
2 Prain_over_canopy.mm.+Psnow_over_canopy.mm.     mm
3                        Relative_Humidity...      -
4                             Wind_speed.m.s.    m/s
5                         Wind_direction.deg. degree
6                              Pressure.mbar.    hPa</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(ltk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 28%">
<col style="width: 45%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">obs_var</th>
<th style="text-align: left;">geotop_where</th>
<th style="text-align: left;">geotop_what</th>
<th style="text-align: left;">unit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">air_temperature</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Tair.C.</td>
<td style="text-align: left;">degC</td>
</tr>
<tr class="even">
<td style="text-align: left;">rainfall_amount</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Prain_over_canopy.mm.+Psnow_over_canopy.mm.</td>
<td style="text-align: left;">mm</td>
</tr>
<tr class="odd">
<td style="text-align: left;">relative_humidity</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Relative_Humidity…</td>
<td style="text-align: left;">-</td>
</tr>
<tr class="even">
<td style="text-align: left;">wind_speed</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Wind_speed.m.s.</td>
<td style="text-align: left;">m/s</td>
</tr>
<tr class="odd">
<td style="text-align: left;">wind_from_direction</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Wind_direction.deg.</td>
<td style="text-align: left;">degree</td>
</tr>
<tr class="even">
<td style="text-align: left;">air_pressure</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Pressure.mbar.</td>
<td style="text-align: left;">hPa</td>
</tr>
<tr class="odd">
<td style="text-align: left;">surface_upwelling_shortwave_flux</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">SWup.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="even">
<td style="text-align: left;">surface_upwelling_longwave_flux</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">LWup.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">surface_downwelling_shortwave_flux</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">SWin.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="even">
<td style="text-align: left;">surface_downwelling_longwave_flux</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">LWin.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">diffuse_downwelling_shortwave_flux_in_air</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">SWdiff.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="even">
<td style="text-align: left;">net_downward_shortwave_flux</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">SWin.W.m2.-SWup.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">net_downward_longwave_flux</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">LWin.W.m2.-LWup.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="even">
<td style="text-align: left;">downward_heat_flux_in_soil</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Soil_heat_flux.W.m2.</td>
<td style="text-align: left;">W/m1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">soil_moisture_content_200</td>
<td style="text-align: left;">SoilLiqContentProfileFile+SoilIceContentProfileFile</td>
<td style="text-align: left;">z0020</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">soil_moisture_content_50</td>
<td style="text-align: left;">SoilLiqContentProfileFile+SoilIceContentProfileFile</td>
<td style="text-align: left;">z0005</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">latent_heat_flux_in_air</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Canopy_fraction…<em>(LEg_veg.W.m2.+LEv.W.m2.)+(1-Canopy_fraction…)</em>LEg_unveg.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
<tr class="even">
<td style="text-align: left;">sensible_heat_flux_in_air</td>
<td style="text-align: left;">PointOutputFile</td>
<td style="text-align: left;">Canopy_fraction…<em>(Hg_veg.W.m2.+Hv.W.m2.)+(1-Canopy_fraction…)</em>Hg_unveg.W.m2.</td>
<td style="text-align: left;">W/m2</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The description of headers in the above table is as below: <!-- dl> --> <!--   <dt>**obs_var**</dt> --> <!--   <dd>name of the observed variables as reported in the csv file for observations;</dd> --></p>
<!--   <dt>**geotop_what**</dt> -->
<!--   <dd>GEOtop keyword corresponding for the oitput point file where the variable is written;</dd> -->
<!--   <dt>**geotop_here**</dt> -->
<!--   <dd>name of the corresponding variable simulated by GEOtop as reported in the output csv file;</dd> -->
<!--   <dt>**unit**</dt> -->
<!--   <dd>measurement unit.</dd> -->
<!-- </dl> -->
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 73%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Variable</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>obs_var</strong></td>
<td>Name of the observed variables as reported in the CSV file for observations.</td>
</tr>
<tr class="even">
<td><strong>geotop_what</strong></td>
<td>GEOtop keyword corresponding to the output point file where the variable is written.</td>
</tr>
<tr class="odd">
<td><strong>geotop_here</strong></td>
<td>Name of the corresponding variable simulated by GEOtop as reported in the output CSV file.</td>
</tr>
<tr class="even">
<td><strong>unit</strong></td>
<td>Measurement unit.</td>
</tr>
</tbody>
</table>
<p>The keywords in <code>geotop_where</code> or <code>geotop_what</code> can be more than one and can be operated through simple mathematical operations.</p>
<ul>
<li><strong>geotoGOF</strong> : It is a wrapper for gof function, it calculates the goodness of fit index for the variables choosen in the data frame returned by <code>geotopLookUpTable</code>; it includes <code>geotopExec</code> and <code>geotopLookukUpTale</code>. Main arguments of <code>geotopGOF</code> are passed to <code>geotopExec</code> as main arguments.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(geotoGOF,<span class="at">help_type=</span><span class="st">"html"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(gof,<span class="at">help_type=</span><span class="st">"gof"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><strong>geotopPSO</strong> : It is a wrapper for <code>hydroPSO</code> function, it calculates the goodness of fit index for the variables choosen in the data frame returned by <code>geotopLookUpTable</code>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(geotoGOF,<span class="at">help_type=</span><span class="st">"html"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">help</span>(gof,<span class="at">help_type=</span><span class="st">"gof"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These functions call other functions and methods of <strong>geotopOptim2</strong> and its dependencies. Before delving into the details of <code>geotopOptim2</code>, the readers attention must be focused on the main dependencies of <code>geotopOptim2</code>, as follows:</p>
<ul>
<li><p><a href="https://cran.r-project.org/web/packages/geotopbricks/index.html" target="_blank">geotopbricks</a>: This package reads the configuration file ‘geotop.inpts’ of a GEOtop Hydrological Model simulation and get or set information on the date used or generated by the simulation (e.g.&nbsp;soil properties, weather time series, soil moisture and evapotranspiration, etc.);</p></li>
<li><p><a href="https://cran.r-project.org/web/packages/hydroGOF/index.html" target="_blank">hydroGOF</a>: It is a set of S3 functions implementing both statistical and graphical goodness-of-fit measures between observed and simulated values, mainly oriented to be used during the calibration, validation, and application of hydrological models;</p></li>
<li><p><a href="https://github.com/hzambran/hydroPSO" target="_blank">hydroPSO</a>: This package implements a state-of-the-art version of the Particle Swarm Optimisation (PSO) algorithm (SPSO-2011 and SPSO-2007 capable). hydroPSO can be used as a replacement of the ‘optim’ R function for (global) optimization of non-smooth and non-linear functions. However, the main focus of hydroPSO is the calibration of environmental and other real-world models that need to be executed from the system console. hydroPSO is model-independent, allowing the user to easily interface any computer simulation model with the calibration engine (PSO). hydroPSO communicates with the model through the model’s own input and output files, without requiring access to the model’s source code. Several PSO variants and controlling options are included to fine-tune the performance of the calibration engine to different calibration problems. An advanced sensitivity analysis function together with user-friendly plotting summaries facilitate the interpretation and assessment of the calibration results. hydroPSO is parallel-capable, to alleviate the computational burden of complex models with “long” execution time. Bugs reports/comments/questions are very welcome (in English, Spanish or Italian).” (Zambrano &amp; Rojas, 2013)</p></li>
</ul>
<p>A package can be drawn as a citation graph in whch functions depend on others. In the following the code lines can reproduce the dependency graph of <strong>geotopOptim2</strong> package and the main functions belong to dependency packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># file appendSmetData.R</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This script creates a graph of the package function and thair main external depencies</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># author: Emanuele Cordano on 09-09-2015</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">#This program is free software: you can redistribute it and/or modify</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">#it under the terms of the GNU General Public License as published by</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">#the Free Software Foundation, either version 3 of the License, or</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">#(at your option) any later version.</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">#This program is distributed in the hope that it will be useful,</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">#but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">#GNU General Public License for more details.</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co">#You should have received a copy of the GNU General Public License</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">#along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"># rm(list=ls())</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co"># library(geotopOptim2)</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co"># library(igraph)</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># set.seed(123)</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="co"># list_envs &lt;- list(environment(geotopExec),environment(get.geotop.inpts.keyword.value),environment(gof),environment(hydroPSO),environment(writeLines),environment(read.table),environment(terrain))</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="co"># names(list_envs) &lt;- c("geotopOptim2","geotopbricks","hydroGOF","hydroPSO","base","utils","raster")</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="co"># color &lt;- c("red","green","blue","orange","yellow","white","brown")</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="co"># names(color) &lt;- names(list_envs)</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co"># list_names &lt;- lapply(X=list_envs,FUN=function(x){ls(env=x)})</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="co"># list_df &lt;- list()</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="co"># for (it in names(list_envs)) {</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="co">#       list_df[[it]]   &lt;- data.frame(funx=list_names[[it]],env=it,color=color[it],stringsAsFactors=FALSE)</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="co"># df &lt;- do.call(what=rbind,args=list_df)</span></span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ##### SEMPLIFICATE DF</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="co"># onlyfun &lt;- list(hydroGOF=c("gof"),hydroPSO=c("hydroPSO","lhoat"),geotopbricks=c("get.geotop.inpts.keyword.value"),</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="co">#       base=c("writeLines","readLines"),utils=c("read.table"),raster="raster") </span><span class="al">###</span><span class="co"> read.table was removed</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a><span class="co"># for (it in names(onlyfun)) {</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="co">#   cond  &lt;- ((df$env==it) &amp; (df$funx %in% onlyfun[[it]])) | (df$env!=it)</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   df    &lt;- df[cond,]</span></span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="co"># fun_names &lt;- df$funx</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="co"># names(fun_names) &lt;- fun_names</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ########################################</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ########################################</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="co"># ########################################</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="co"># ########################################</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a><span class="co"># ########################################</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="co"># lfunx &lt;- lapply(X=fun_names,FUN=function(x,nx) {</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- try(get(x),silent=TRUE)</span></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="co">#           if (class(o)=="try-error") {</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a><span class="co">#               o &lt;- NA </span><span class="al">###</span><span class="co"> "It looks like a method!"</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a><span class="co">#               return(o)</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a><span class="co">#           }</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- formals(o)</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- lapply(X=o,FUN=as.character)</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- unlist(o)</span></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- o[o %in% nx]</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="co">#           src &lt;-  as.character(body(x))</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="co">#           src &lt;-  unlist(str_split(src, boundary("word")))</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a><span class="co">#           nx &lt;-  src[src %in% nx]</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- c(o,nx)</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a><span class="co">#           o &lt;- unique(o)</span></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a><span class="co">#           return(o)</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a><span class="co">#       },nx=fun_names)</span></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="co"># for (it in names(lfunx)) {</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a><span class="co">#   temp &lt;- lfunx[[it]]</span></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a><span class="co">#   ii &lt;- which(temp!=it)</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a><span class="co">#   temp &lt;- temp[ii]</span></span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a><span class="co">#   nl &lt;- length(temp)</span></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a><span class="co">#   lfunx[[it]] &lt;- array(c(rep(it,nl),temp),c(nl,2))</span></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a><span class="co"># #####edges</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a><span class="co"># edges &lt;- do.call(rbind,lfunx)</span></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a><span class="co"># vertices &lt;- unique(edges)</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a><span class="co"># #####</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a><span class="co"># env_base &lt;- "base;utils"</span></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a><span class="co"># df$env[df$env=="base"]  &lt;- env_base</span></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="co"># df$env[df$env=="utils"] &lt;- env_base</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a><span class="co"># df$color[df$env==env_base] &lt;- "white"</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a><span class="co"># #####</span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a><span class="co"># color_ &lt;- df$color</span></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a><span class="co"># env_   &lt;- df$env</span></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a><span class="co"># names(color_) &lt;- df$funx</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="co"># names(env_) &lt;- df$funx</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="co"># ######</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="co"># gg &lt;- graph_from_edgelist(edges)</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="co"># vnames &lt;- V(gg)$name</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a><span class="co"># V(gg)$color &lt;- color_[vnames]</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a><span class="co"># vcodes &lt;- sprintf("%02d",1:length(vnames))</span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a><span class="co"># names(vcodes) &lt;- vnames</span></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a><span class="co"># V(gg)$name &lt;- vcodes</span></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a><span class="co"># main &lt;- "geeotopOptim2  Internal Functions"</span></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(gg,main=main)</span></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a><span class="co"># legend("bottomleft",legend=unique(env_),fill=unique(color_),ncol=2)</span></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a><span class="co"># legend("topleft",legend=paste(vcodes,vnames,sep=" : "),ncol=3,cex=0.6)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The graph show</p>
<ul>
<li>geotopExec</li>
<li>geotopGOF</li>
<li>geotopLook</li>
<li>geotopPSO</li>
</ul>
<p>Note the various macros within the <code>vignette</code> section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the <code>title</code> field and the <code>\VignetteIndexEntry</code> to match the title of your vignette.</p>
</section>
<section id="exercise" class="level2">
<h2 class="anchored" data-anchor-id="exercise">Exercise</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># file pso_example_script.R</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This script is an examples of a GEOtop calibration via geotopOptim2</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co"># author: Emanuele Cordano on 09-09-2015</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co">#This program is free software: you can redistribute it and/or modify</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">#it under the terms of the GNU General Public License as published by</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#the Free Software Foundation, either version 3 of the License, or</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">#(at your option) any later version.</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">#This program is distributed in the hope that it will be useful,</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">#but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="co">#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">#GNU General Public License for more details.</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co">#You should have received a copy of the GNU General Public License</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co">#along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="do">###############################################################################</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geotopOptim2)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7988</span>)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>USE_RMPI <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (USE_RMPI<span class="sc">==</span><span class="cn">TRUE</span>) {</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(<span class="st">"parallel"</span>)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(Rmpi)</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">require</span>(snow)</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">mpi.comm.rank</span>(<span class="dv">0</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sink</span>(<span class="at">file=</span><span class="st">"/dev/null"</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">#runMPIslave()</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">slaveLoop</span>(<span class="fu">makeMPImaster</span>())</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mpi.quit</span>()</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    parallel <span class="ot">&lt;-</span> <span class="st">"parallel"</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>    npart <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>    control <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">5</span>,<span class="at">npart=</span>npart,<span class="at">parallel=</span>parallel)</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>    parellel <span class="ot">&lt;-</span> <span class="st">"none"</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>    npart <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>    control <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">maxit=</span><span class="dv">2</span>,<span class="at">npart=</span>npart)</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is a GEOtop simulation folder with observation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>tz <span class="ot">&lt;-</span> <span class="st">"Etc/GMT-1"</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>wpath <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">'geotop-simulation/B2site'</span>,<span class="at">package=</span><span class="st">"geotopOptim2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the full name (with complete path) of GEOtop executable built file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>bin  <span class="ot">&lt;-</span> <span class="st">'/home/ecor/local/geotop/GEOtop/bin/geotop-2.0.0'</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In most cases, geotopOptim2 copies the simulation folder and run GEOtop with modified calibration input parameters in temporary directories:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">## LOcal path where to write output for PSO</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>runpath <span class="ot">&lt;-</span> <span class="st">"/home/lv70864/ecordano/temp/geotopOptim_tests"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>runpath <span class="ot">&lt;-</span> <span class="st">"/home/ecor/temp/geotopOptim_tests"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <strong>geotopExec</strong> running a GEOtop simulation can enter a vector of paratemers which are replaced with the ones formerly set in the original simulation directory <strong>wpath</strong> . Analogously the function <strong>geotopPSO</strong> performing a PSO calibration of GEOtop through <strong>geotopExec</strong> and <strong>geotopGOF</strong> needs two vectors: one for upper values, the other for lower values. A set of soil calibration parameters can be set though a csv file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">help</span>(geotopExec,<span class="at">help_type=</span><span class="st">"html"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">help</span>(geotopGOF,<span class="at">help_type=</span><span class="st">"html"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">help</span>(geotopPSO,<span class="at">help_type=</span><span class="st">"html"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is an example that can be downloaded from the package examples:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>geotop.soil.param.file <span class="ot">&lt;-</span>  <span class="fu">paste</span>(<span class="st">"geotopOptim2/inst/examples_script/param/param_pso_c003.csv"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>geotop.soil.param <span class="ot">&lt;-</span> <span class="fu">read.table</span>(geotop.soil.param.file,<span class="at">header=</span><span class="cn">TRUE</span>,<span class="at">sep=</span><span class="st">","</span>,<span class="at">stringsAsFactors=</span><span class="cn">FALSE</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>lower <span class="ot">&lt;-</span> geotop.soil.param<span class="sc">$</span>lower</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>upper <span class="ot">&lt;-</span> geotop.soil.param<span class="sc">$</span>upper</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>suggested <span class="ot">&lt;-</span> geotop.soil.param<span class="sc">$</span>suggested</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(lower) <span class="ot">&lt;-</span> geotop.soil.param<span class="sc">$</span>name</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(upper) <span class="ot">&lt;-</span> geotop.soil.param<span class="sc">$</span>name</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(suggested) <span class="ot">&lt;-</span>  geotop.soil.param<span class="sc">$</span>name</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(geotop.soil.param)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: right;">lower</th>
<th style="text-align: right;">suggested</th>
<th style="text-align: right;">upper</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SOIL__N</td>
<td style="text-align: right;">1.2e+00</td>
<td style="text-align: right;">1.70</td>
<td style="text-align: right;">2.5e+00</td>
</tr>
<tr class="even">
<td style="text-align: left;">SOIL__Alpha</td>
<td style="text-align: right;">1.0e-05</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">1.0e-01</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SOIL__ThetaSat</td>
<td style="text-align: right;">5.0e-01</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">7.0e-01</td>
</tr>
<tr class="even">
<td style="text-align: left;">SOIL__ThetaRes</td>
<td style="text-align: right;">5.0e-02</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">7.0e-02</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SOIL__LateralHydrConductivity</td>
<td style="text-align: right;">1.0e-03</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">1.0e+00</td>
</tr>
<tr class="even">
<td style="text-align: left;">SOIL__NormalHydrConductivity</td>
<td style="text-align: right;">1.0e-03</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">1.0e+00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SOIL__SoilInitPres_ALL</td>
<td style="text-align: right;">-5.0e+03</td>
<td style="text-align: right;">-500.00</td>
<td style="text-align: right;">1.0e+03</td>
</tr>
<tr class="even">
<td style="text-align: left;">SOIL__SoilDepth</td>
<td style="text-align: right;">3.0e+03</td>
<td style="text-align: right;">3100.00</td>
<td style="text-align: right;">3.0e+04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SOIL__NumberOfSoilLayers</td>
<td style="text-align: right;">9.0e+00</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">2.0e+01</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Here the columns <code>lower</code> and <code>upper</code> stand for lower and upper values whereas the <code>suggested</code> column contains initial guess values for <code>geotopPSO</code>. Generally a good practical examples on how to set these parameters is given below:</p>
<pre><code>prefix__name,lower,upperGrenarally 
SOIL__N,1.45,1.89
SOIL__Alpha,0.00131,0.0131
SOIL__ThetaSat,0.41,0.53
SOIL__ThetaSat_bottomlayer,0.08,0.09
SOIL__ThetaRes,0.05,0.07
SOIL__LateralHydrConductivity,0.0923,0.1
SOIL__NormalHydrConductivity,0.0923,0.1
SOIL__LateralHydrConductivity_bottomlayer,0.00923,0.01
SOIL__NormalHydrConductivity_bottomlayer,0.00923,0.01
SOIL__SoilInitPresL0001,-10000,100
SOIL__SoilInitPresL0002,-10000,100
SOIL__SoilInitPresL0003,-10000,100
SOIL__SoilInitPresL0004,-10000,100
SOIL__SoilInitPresL0005,-10000,100
SOIL__SoilInitPresL0006,-10000,100
SOIL__SoilInitPresL0007,-10000,1000
SOIL__SoilInitPresL0008,-10000,1000
SOIL__SoilInitPresL0009,-10000,0
SOIL__PsiGamma,0.5,1
SOIL__SoilDepth,3000,30000
SOIL__NumberOfSoilLayers,9,20
VECTOR_1_LSAI,2,4</code></pre>
<p>where <code>N</code>, <code>Alpha</code>, <code>ThetaSat</code>, <code>LateralHydrConductivity</code>, <code>NormalHydrConductivity</code>, <code>ThetaRes</code>, are GEOtop keywords referred to the respective soil parameters. By default, <code>geotopPSO</code> considers soil parameters uniformly distributed within the soil profile unless they are repated in the CSV file with some suffixes, like <code>_bottomlayer</code> or <code>_ALL</code>. In <code>_bottomlayer</code> case, the parameter (upper and lower) values are referred to the first (near surface) layer and the last (bottom) layer and the values of internal layers are exponentially interpolated. In this case a decrease of hydraulic conductivity or soil porosity can be modeled. In <code>_ALL</code> case, soil parameter is taken as variables with soil layers. So the reported values refer to a range for so many soil parameter of the same type how many the soil layers are. If the keywords contains the suffix <code>_V_L%04d</code> with the decimal formatter, the soil parameter is calibrated only for the soil specific layer. The keyword <code>SoilInitPres</code> refers to the initial soil water pressure head. If the formatter <code>L%04d</code> is appended as a suffix, the value is referred to the indicated layer. The keyword <code>PsiGamma</code> refers to the soil water pressure gradient along the terrain-normal downward direction and is applied to calculate initial soil water pressure head in the above layers assuming a continuous profile. <code>SoilDepth</code> and <code>NumberOfSoilLayers</code> refer to the whole soil depth (which now corresponds to the whole soil column used as domain for balance equation integration) and the number of soil layers in which the soil column is divided. Soil layer thickness increase with depth following a geometric progression.</p>
<p>Then, the target variables are set here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>var <span class="ot">&lt;-</span> <span class="st">'soil_moisture_content_50'</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> (upper<span class="sc">+</span>lower)<span class="sc">/</span><span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pso <span class="ot">&lt;-</span> <span class="fu">geotopPSO</span>(<span class="at">par=</span>suggested,<span class="at">run.geotop=</span><span class="cn">TRUE</span>,<span class="at">bin=</span>bin,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>        <span class="at">simpath=</span>wpath,<span class="at">runpath=</span>runpath,<span class="at">clean=</span><span class="cn">TRUE</span>,<span class="at">data.frame=</span><span class="cn">TRUE</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">level=</span><span class="dv">1</span>,<span class="at">intern=</span><span class="cn">TRUE</span>,<span class="at">target=</span>var,<span class="at">gof.mes=</span><span class="st">"RMSE"</span>,<span class="at">lower=</span>lower,<span class="at">upper=</span>upper,<span class="at">control=</span>control)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (USE_RMPI<span class="sc">==</span><span class="cn">TRUE</span>) <span class="fu">mpi.finalize</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note the various macros within the <code>vignette</code> section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the <code>title</code> field and the <code>VignetteIndexEntry</code> to match the title of your vignette.</p>
</section>
<section id="examples" class="level2">
<h2 class="anchored" data-anchor-id="examples">Examples</h2>
<p>Examples of simulations to optimize could be found here <a href="https://github.com/EURAC-Ecohydro/geotopOptim2/tree/master/inst/examples_script" target="_blank">https://github.com/EURAC-Ecohydro/geotopOptim2/tree/master/inst/examples_script</a></p>
<p>Examples of scripts to launch optimization in background on a cluster for the EURAC Monalisa dataset could be found here: <a href="https://github.com/EURAC-Ecohydro/MonaLisa/tree/master/Rscript" target="_blank">https://github.com/EURAC-Ecohydro/MonaLisa/tree/master/Rscript</a></p>
</section>
<section id="visulatization-tools" class="level2">
<h2 class="anchored" data-anchor-id="visulatization-tools">Visulatization tools</h2>
<p>R-based graphical visualization tool of the optimized simulations could be found here: <a href="https://github.com/EURAC-Ecohydro/geotopOptim2/tree/master/inst/examples_animation" target="_blank">https://github.com/EURAC-Ecohydro/geotopOptim2/tree/master/inst/examples_animation</a></p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><p>Endrizzi, S., Gruber, S., Dall’Amico, M., and Rigon, R. (2014): GEOtop 2.0: simulating the combined energy and water balance at and below the land surface accounting for soil freezing, snow cover and terrain effects, Geosci. Model Dev., 7, 2831-2857, doi: <a href="https://doi.org/10.5194/gmd-7-2831-2014" target="_blank">https://doi.org/10.5194/gmd-7-2831-2014</a></p></li>
<li><p>Zambrano-Bigiarini, M.; R. Rojas (2013), A model-independent Particle Swarm Optimisation software for model calibration, Environmental Modelling &amp; Software, 43, 5-25, doi: <a href="https://doi.org/10.1016/j.envsoft.2013.01.004" target="_blank">https://doi.org/10.1016/j.envsoft.2013.01.004</a></p></li>
<li><p>Zambrano-Bigiarini, M., Rojas, R. (2014). hydroPSO: Particle Swarm Optimisation, with focus on Environmental Models. R package version 0.3-4. <a href="https://github.com/hzambran/hydroPSO" target="_blank">https://github.com/hzambran/hydroPSO</a></p></li>
<li><p>Cordano E., Andreis D. and Zottele F. (2015). geotopbricks: An R Plug-in for the Distributed Hydrological Model GEOtop. R package version 1.3.6. <a href="http://CRAN.R-project.org/package=geotopbricks" target="_blank">http://CRAN.R-project.org/package=geotopbricks</a></p></li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>